<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дроби: Разделяй и Властвуй!</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', 'Marker Felt', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #ffd6e7, #c1e3ff);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 1000px;
            background: white;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            padding: 30px;
            position: relative;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            background: linear-gradient(to right, #ff7eb3, #65c6ff);
            padding: 20px;
            border-radius: 20px;
            color: white;
            position: relative;
        }
        
        h1 {
            font-size: 2.3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .emoji-header {
            font-size: 3rem;
            margin: 15px 0;
        }
        
        .task-description {
            background: #f0f9ff;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 25px;
            border: 3px dashed #65c6ff;
            text-align: center;
            font-size: 1.4rem;
            line-height: 1.6;
        }
        
        .task-description span {
            font-weight: bold;
            color: #ff6b9d;
            background: #fff0f5;
            padding: 5px 15px;
            border-radius: 15px;
            display: inline-block;
            margin: 0 5px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        .visualization-area {
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
            overflow-x: auto;
            padding: 10px;
        }
        
        .object-container {
            position: relative;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 20px;
            overflow: hidden;
            border: 4px solid transparent;
            width: 240px;
            height: 280px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }
        
        .object-container.selected {
            border-color: #ff6b9d;
            box-shadow: 0 0 20px rgba(255, 107, 157, 0.5);
            transform: scale(1.05);
        }
        
        .object-label {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 10px;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            display: inline-block;
        }
        
        .pizza-container {
            width: 200px;
            height: 200px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .pizza {
            width: 180px;
            height: 180px;
            background: linear-gradient(135deg, #ff9e68, #ff6b45);
            border-radius: 50%;
            border: 8px solid #f5c89d;
            position: relative;
            overflow: visible;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateZ(0);
        }
        
        .pizza::before {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 50% 50%, #ffdc7a 0%, transparent 15%),
                repeating-radial-gradient(circle at 20% 30%, #ff9e68 0px, #ff9e68 2px, #ff6b45 2px, #ff6b45 4px);
            border-radius: 50%;
        }
        
        .chocolate {
            width: 200px;
            height: 130px;
            background: linear-gradient(135deg, #7b3f00, #4d2600);
            border-radius: 10px;
            position: relative;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-top: 35px;
        }
        
        .chocolate::before {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, transparent 49%, rgba(255, 255, 255, 0.1) 50%, transparent 51%),
                linear-gradient(0deg, transparent 49%, rgba(255, 255, 255, 0.1) 50%, transparent 51%),
                radial-gradient(circle at 30% 30%, #a05a1a 0px, #a05a1a 2px, #7b3f00 2px, #7b3f00 4px);
        }
        
        .cupcakes-container {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, #ffd1dc, #ffb6c1);
            border-radius: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding: 15px;
            gap: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            position: relative;
            margin-top: 0;
        }
        
        .cupcake-box {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .cupcake {
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        
        .cupcake-base {
            position: absolute;
            background: linear-gradient(to bottom, #f9c5bd, #f8a29a);
            border-radius: 0 0 8px 8px;
            bottom: 0;
        }
        
        .cupcake-top {
            position: absolute;
            background: linear-gradient(135deg, #ff9e68, #ff6b45);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            top: 5%;
        }
        
        .cupcake-cherry {
            position: absolute;
            z-index: 2;
            top: -10%;
        }
        
        .cupcake.selected {
            transform: scale(1.1);
            filter: drop-shadow(0 0 8px rgba(255, 107, 157, 0.8));
        }
        
        .slice {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            clip-path: polygon(50% 50%, 100% 0, 100% 100%);
            transform-origin: center;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            opacity: 1;
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: auto;
        }
        
        .slice-line {
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            background: white;
            transform-origin: center;
            pointer-events: none;
            transform: translateX(-1px);
        }
        
        .chocolate-piece {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chocolate-piece:hover, .slice:hover, .cupcake:hover {
            transform: scale(1.05);
            z-index: 1;
        }
        
        .slice.selected {
            background: linear-gradient(135deg, rgba(168, 255, 120, 0.7), rgba(120, 255, 214, 0.7));
        }
        
        .chocolate-piece.selected {
            background: linear-gradient(135deg, #a8ff78, #78ffd6);
            box-shadow: 0 0 10px rgba(168, 255, 120, 0.7) inset;
        }
        
        .cupcake.selected .cupcake-top {
            background: linear-gradient(135deg, #a8ff78, #78ffd6);
            box-shadow: 0 0 8px rgba(168, 255, 120, 0.7) inset;
        }
        
        .selected-highlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(168, 255, 120, 0.3);
            z-index: 10;
            pointer-events: none;
            border-radius: inherit;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
        }
        
        .control-group {
            background: #f0f9ff;
            border-radius: 18px;
            padding: 20px;
            min-width: 250px;
            text-align: center;
            border: 3px dashed #65c6ff;
        }
        
        .control-group h3 {
            margin-bottom: 15px;
            color: #ff6b9d;
        }
        
        .buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }
        
        .denominator-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        button {
            background: linear-gradient(to bottom, #65c6ff, #2a9df4);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 15px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            min-width: 50px;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        button:active:not(:disabled) {
            transform: translateY(1px);
        }
        
        .feedback {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 18px;
            font-size: 1.4rem;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.5s ease;
        }
        
        .positive {
            background: linear-gradient(to right, #a8ff78, #78ffd6);
            border: 3px solid #4caf50;
        }
        
        .negative {
            background: linear-gradient(to right, #ff9d6f, #ff6b9d);
            border: 3px solid #f44336;
        }
        
        .neutral {
            background: linear-gradient(to right, #a8e6ff, #d4fffc);
            border: 3px solid #2196f3;
        }
        
        .progress {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f0f9ff;
            border-radius: 18px;
            padding: 15px;
            margin-top: 20px;
            border: 3px dashed #65c6ff;
        }
        
        .xp-counter {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ff6b9d;
        }
        
        .rank-display {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ff6b9d;
            background: #fff0f5;
            padding: 5px 15px;
            border-radius: 50px;
            margin-top: 10px;
        }
        
        .badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 15px;
        }
        
        .badge {
            background: linear-gradient(to bottom, #ffdc7a, #ffb347);
            border-radius: 50px;
            padding: 6px 12px;
            font-size: 0.8rem;
            color: #7b3f00;
            display: flex;
            align-items: center;
            gap: 5px;
            opacity: 0.6;
        }
        
        .badge.earned {
            opacity: 1;
            box-shadow: 0 0 10px #ffb347;
            animation: glow 1.5s ease-in-out;
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 5px #ffb347; }
            50% { box-shadow: 0 0 20px #ffb347; }
            100% { box-shadow: 0 0 10px #ffb347; }
        }
        
        .fraction-display {
            font-size: 3rem;
            font-weight: bold;
            margin: 15px 0;
            color: #ff6b9d;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 60px;
        }
        
        .hidden {
            display: none;
        }
        
        .instructions {
            text-align: center;
            margin: 15px 0;
            font-size: 1.2rem;
            color: #666;
        }
        
        @media (max-width: 900px) {
            .visualization-area {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .object-container {
                width: 200px;
                height: 250px;
            }
            
            .pizza-container, .cupcakes-container {
                width: 160px;
                height: 160px;
            }
            
            .pizza {
                width: 140px;
                height: 140px;
            }
            
            .chocolate {
                width: 160px;
                height: 100px;
                margin-top: 30px;
            }
        }
        
        @media (max-width: 600px) {
            .visualization-area {
                flex-direction: column;
                align-items: center;
            }
            
            .object-container {
                width: 180px;
                height: 220px;
            }
            
            .pizza-container, .cupcakes-container {
                width: 140px;
                height: 140px;
            }
            
            .pizza {
                width: 120px;
                height: 120px;
            }
            
            .chocolate {
                width: 140px;
                height: 90px;
                margin-top: 25px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .denominator-buttons {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .control-group {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Дроби: Разделяй и Властвуй! 🍕🍫🧁</h1>
            <div class="emoji-header">🔪 ✂️ ➗ 🧩 = 📊</div>
            <p>Изучай дроби, разделяя вкусности на части!</p>
        </div>
        
        <div class="task-description">
            <p>Задание: <span id="task-text">Покажи дробь 3/4 на пицце</span></p>
            <div class="fraction-display">?</div>
        </div>
        
        <div class="instructions">
            <p>1. Выбери предмет, соответствующий заданию 👇</p>
            <p>2. Раздели его на части 🔢</p>
            <p>3. Выбери нужное количество частей 🎯</p>
        </div>
        
        <div class="visualization-area">
            <div class="object-container" data-object="pizza">
                <div class="pizza-container">
                    <div class="pizza" id="pizza"></div>
                </div>
                <p class="object-label">🍕 Пицца</p>
            </div>
            
            <div class="object-container" data-object="chocolate">
                <div class="chocolate" id="chocolate"></div>
                <p class="object-label">🍫 Шоколадка</p>
            </div>
            
            <div class="object-container" data-object="cupcakes">
                <div class="cupcakes-container" id="cupcakes-container">
                    <div class="cupcake-box" id="cupcake-box"></div>
                </div>
                <p class="object-label">🧁 Коробка кексов</p>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>🔪 Разделить на:</h3>
                <div class="buttons denominator-buttons" id="denominator-buttons">
                    <!-- Кнопки будут созданы скриптом -->
                </div>
            </div>
            
            <div class="control-group">
                <h3>🎯 Взять частей:</h3>
                <div class="buttons" id="numerator-buttons">
                    <!-- Кнопки будут созданы скриптом -->
                </div>
            </div>
        </div>
        
        <div class="feedback neutral">
            <p>Выбери предмет, соответствующий заданию!</p>
            <p class="emoji">👇🔍</p>
        </div>
        
        <div class="progress">
            <div class="xp-counter">XP: <span id="xp">0</span></div>
            <div class="rank-display">Ранг: <span id="rank">Младший Шеф-Математик</span></div>
        </div>
        
        <div class="badges">
            <div class="badge">🥇 Младший Шеф-Математик</div>
            <div class="badge">🥈 Шеф-Математик</div>
            <div class="badge">🏆 Мастер-Математик</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Уровни и ранги
            const levels = [
                { xp: 0, name: "Новичок", rank: "Младший Шеф-Математик" },
                { xp: 10, name: "Ученик", rank: "Шеф-Математик" },
                { xp: 25, name: "Знаток", rank: "Мастер-Математик" },
                { xp: 45, name: "Эксперт", rank: "Гений Дробей" },
                { xp: 70, name: "Гуру", rank: "Великий Математик" }
            ];
            
            // Состояние приложения
            const state = {
                currentObject: null,
                denominator: null,
                numerator: null,
                currentFraction: null,
                currentTask: null,
                xp: 0,
                completedTasks: 0,
                tasks: [],
                currentTaskIndex: 0,
                selectedObject: null
            };
            
            // Генерация уникальных задач с балансировкой по типам
            function generateUniqueTasks() {
                const tasks = [];
                const fractions = new Set();
                
                // Создаем по 2 задания для каждого типа
                const objectTypes = ['pizza', 'chocolate', 'cupcakes'];
                const typeCount = { pizza: 0, chocolate: 0, cupcakes: 0 };
                
                while (tasks.length < 6) {
                    // Выбираем тип, у которого меньше заданий
                    let availableTypes = objectTypes.filter(type => typeCount[type] < 2);
                    if (availableTypes.length === 0) availableTypes = objectTypes;
                    
                    const object = availableTypes[Math.floor(Math.random() * availableTypes.length)];
                    
                    // Для каждого типа объекта подбираем подходящие дроби
                    let numerator, denominator;
                    
                    if (object === 'pizza') {
                        // Для пиццы используем только 4, 6, 8 и 10 частей
                        const pizzaDenominators = [4, 6, 8, 10];
                        denominator = pizzaDenominators[Math.floor(Math.random() * pizzaDenominators.length)];
                        numerator = Math.floor(Math.random() * (denominator - 1)) + 1;
                    } else if (object === 'chocolate') {
                        denominator = [2, 4, 5, 8, 10][Math.floor(Math.random() * 5)];
                        numerator = Math.floor(Math.random() * (denominator - 1)) + 1;
                    } else { // cupcakes
                        denominator = [2, 3, 4, 5, 6, 10][Math.floor(Math.random() * 6)];
                        numerator = Math.floor(Math.random() * (denominator - 1)) + 1;
                    }
                    
                    const fractionStr = `${numerator}/${denominator}`;
                    
                    // Проверяем уникальность дроби
                    if (!fractions.has(fractionStr)) {
                        fractions.add(fractionStr);
                        tasks.push({
                            object: object,
                            fraction: [numerator, denominator],
                            text: `Покажи дробь ${fractionStr} на ${object === 'pizza' ? 'пицце' : object === 'chocolate' ? 'шоколадке' : 'кексах'}`
                        });
                        typeCount[object]++;
                    }
                }
                
                return tasks;
            }
            
            // Элементы DOM
            const elements = {
                pizza: document.getElementById('pizza'),
                chocolate: document.getElementById('chocolate'),
                cupcakeBox: document.getElementById('cupcake-box'),
                cupcakesContainer: document.getElementById('cupcakes-container'),
                taskText: document.getElementById('task-text'),
                feedback: document.querySelector('.feedback'),
                xpDisplay: document.getElementById('xp'),
                rankDisplay: document.getElementById('rank'),
                fractionDisplay: document.querySelector('.fraction-display'),
                objectContainers: document.querySelectorAll('.object-container'),
                denominatorButtons: document.getElementById('denominator-buttons'),
                numeratorButtons: document.getElementById('numerator-buttons')
            };
            
            // Инициализация приложения
            function init() {
                // Создаем кнопки знаменателя (2-10)
                for (let i = 2; i <= 10; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.dataset.parts = i;
                    button.disabled = true;
                    elements.denominatorButtons.appendChild(button);
                }
                
                // Создаем кнопки числителя (1-10)
                for (let i = 1; i <= 10; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.id = `take-${i}`;
                    button.disabled = true;
                    elements.numeratorButtons.appendChild(button);
                }
                
                state.tasks = generateUniqueTasks();
                loadTask();
                setupEventListeners();
            }
            
            // Загрузка задания
            function loadTask() {
                state.currentTask = state.tasks[state.currentTaskIndex];
                state.currentObject = state.currentTask.object;
                state.currentFraction = state.currentTask.fraction;
                state.denominator = null;
                state.numerator = null;
                state.selectedObject = null;
                
                // Обновление интерфейса
                elements.taskText.textContent = state.currentTask.text;
                elements.fractionDisplay.textContent = "?";
                elements.feedback.className = "feedback neutral";
                elements.feedback.innerHTML = `<p>Выбери предмет, соответствующий заданию!</p><p class="emoji">👇🔍</p>`;
                
                // Очистка визуализации
                clearVisualization();
                
                // Сброс выбранного объекта
                elements.objectContainers.forEach(container => {
                    container.classList.remove('selected');
                });
                
                // Блокировка кнопок
                disableDenominatorButtons();
                disableNumeratorButtons();
            }
            
            // Очистка визуализации
            function clearVisualization() {
                // Очистка пиццы
                const pizzaSlices = document.querySelectorAll('.slice, .slice-line, .selected-highlight');
                pizzaSlices.forEach(slice => slice.remove());
                
                // Очистка шоколадки
                const chocolatePieces = document.querySelectorAll('.chocolate-piece, .selected-highlight');
                chocolatePieces.forEach(piece => piece.remove());
                
                // Очистка кексов
                elements.cupcakeBox.innerHTML = '';
            }
            
            // Создание кексов (исправленная версия)
            function createCupcakes(count) {
                elements.cupcakeBox.innerHTML = '';
                const container = elements.cupcakesContainer;
                
                // Получаем реальные размеры контейнера
                const containerWidth = container.offsetWidth;
                const containerHeight = container.offsetHeight;
                
                // Рассчитываем оптимальное расположение
                let columns, rows;
                let gap = 8;
                
                // Оптимальная сетка в зависимости от количества кексов
                if (count === 1) {
                    columns = 1;
                    rows = 1;
                } else if (count === 2) {
                    columns = 2;
                    rows = 1;
                    gap = 15; // Больше зазор для 2 кексов
                } else if (count === 3) {
                    columns = 2;
                    rows = 2;
                    gap = 8;
                } else if (count === 4) {
                    columns = 2;
                    rows = 2;
                    gap = 10;
                } else if (count === 5 || count === 6) {
                    columns = 3;
                    rows = 2;
                    gap = 6;
                } else {
                    columns = Math.min(4, count);
                    rows = Math.ceil(count / columns);
                    gap = 5;
                }
                
                // Рассчитываем размеры кексов
                const cupcakeWidth = Math.min(
                    (containerWidth - (columns - 1) * gap) / columns,
                    (containerHeight - (rows - 1) * gap) / rows / 1.4
                );
                
                const cupcakeHeight = cupcakeWidth * 1.4;
                
                // Создаем кексы
                for (let i = 0; i < count; i++) {
                    const cupcake = document.createElement('div');
                    cupcake.className = 'cupcake';
                    cupcake.style.width = `${cupcakeWidth}px`;
                    cupcake.style.height = `${cupcakeHeight}px`;
                    
                    // Основа кекса
                    const base = document.createElement('div');
                    base.className = 'cupcake-base';
                    base.style.width = `${cupcakeWidth * 0.8}px`;
                    base.style.height = `${cupcakeHeight * 0.35}px`;
                    
                    // Верхушка кекса
                    const top = document.createElement('div');
                    top.className = 'cupcake-top';
                    top.style.width = `${cupcakeWidth * 0.7}px`;
                    top.style.height = `${cupcakeHeight * 0.35}px`;
                    
                    // Вишенка
                    const cherry = document.createElement('div');
                    cherry.className = 'cupcake-cherry';
                    cherry.textContent = '🍒';
                    cherry.style.fontSize = `${Math.max(10, cupcakeWidth * 0.15)}px`;
                    top.appendChild(cherry);
                    
                    cupcake.appendChild(top);
                    cupcake.appendChild(base);
                    cupcake.dataset.index = i;
                    cupcake.addEventListener('click', () => selectCupcake(cupcake));
                    
                    elements.cupcakeBox.appendChild(cupcake);
                }
                
                // Центрируем кексы для нечетных количеств
                if (count === 3 || count === 5) {
                    elements.cupcakeBox.style.justifyContent = 'center';
                } else {
                    elements.cupcakeBox.style.justifyContent = 'space-around';
                }
            }
            
            // Выбор кекса
            function selectCupcake(cupcake) {
                if (state.currentObject !== 'cupcakes' || !state.denominator) return;
                
                cupcake.classList.toggle('selected');
                const selected = document.querySelectorAll('.cupcake.selected').length;
                
                // Обновление числителя
                state.numerator = selected;
                updateFractionDisplay();
                
                // Проверка решения
                checkSolution();
            }
            
            // Настройка обработчиков событий
            function setupEventListeners() {
                // Выбор объекта
                elements.objectContainers.forEach(container => {
                    container.addEventListener('click', () => {
                        const objectType = container.dataset.object;
                        
                        // Сброс предыдущего выбора
                        elements.objectContainers.forEach(c => c.classList.remove('selected'));
                        
                        // Выбор текущего объекта
                        container.classList.add('selected');
                        state.selectedObject = objectType;
                        
                        // Проверка правильности выбора объекта
                        if (state.selectedObject === state.currentObject) {
                            elements.feedback.className = "feedback positive";
                            elements.feedback.innerHTML = `<p>Правильно! Ты выбрал ${getObjectName()} 🎉</p><p>Теперь раздели его на части!</p>`;
                            enableDenominatorButtons();
                        } else {
                            elements.feedback.className = "feedback negative";
                            elements.feedback.innerHTML = `<p>Попробуй ещё раз! 🤔</p><p>В задании указан другой предмет.</p>`;
                            disableDenominatorButtons();
                        }
                    });
                });
                
                // Кнопки знаменателя
                elements.denominatorButtons.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', () => {
                        const denominator = parseInt(button.dataset.parts);
                        
                        // Проверка правильности знаменателя
                        if (denominator === state.currentFraction[1]) {
                            setDenominator(denominator);
                        } else {
                            elements.feedback.className = "feedback negative";
                            elements.feedback.innerHTML = `<p>Почти! 🤔</p><p>Попробуй выбрать другое количество.</p>`;
                        }
                    });
                });
                
                // Кнопки числителя
                elements.numeratorButtons.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', () => {
                        const numerator = parseInt(button.textContent);
                        setNumerator(numerator);
                    });
                });
            }
            
            // Установка знаменателя
            function setDenominator(denominator) {
                state.denominator = denominator;
                state.numerator = null; // Сброс числителя при изменении знаменателя
                
                // Обновление интерфейса
                updateFractionDisplay();
                
                // Подготовка числительных кнопок
                prepareNumeratorButtons();
                
                // Визуализация разделения
                visualizeDivision();
                
                // Активация кнопок числителя
                enableNumeratorButtons();
                
                // Обновление обратной связи
                elements.feedback.className = "feedback neutral";
                elements.feedback.innerHTML = `<p>Отлично! Теперь выбери количество частей.</p>`;
            }
            
            // Визуализация разделения
            function visualizeDivision() {
                if (state.currentObject === 'pizza') {
                    // Для пиццы - создаем срезы
                    createPizzaSlices();
                } else if (state.currentObject === 'chocolate') {
                    // Для шоколадки - разделить на части
                    divideChocolate();
                } else if (state.currentObject === 'cupcakes') {
                    // Для кексов - показать нужное количество
                    createCupcakes(state.denominator);
                }
            }
            
            // Разделение шоколадки на равные части
            function divideChocolate() {
                elements.chocolate.innerHTML = '';
                
                // Определяем оптимальную сетку
                let rows = 1;
                let cols = state.denominator;
                
                // Для больших знаменателей делаем 2 ряда
                if (state.denominator > 5) {
                    rows = 2;
                    cols = Math.ceil(state.denominator / 2);
                }
                
                // Создаем части
                const width = 100 / cols;
                const height = 100 / rows;
                
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const index = row * cols + col;
                        if (index >= state.denominator) break;
                        
                        const piece = document.createElement('div');
                        piece.className = 'chocolate-piece';
                        piece.style.width = `${width}%`;
                        piece.style.height = `${height}%`;
                        piece.style.left = `${col * width}%`;
                        piece.style.top = `${row * height}%`;
                        piece.textContent = '🍫';
                        piece.dataset.index = index;
                        piece.addEventListener('click', () => selectChocolatePiece(piece));
                        elements.chocolate.appendChild(piece);
                    }
                }
            }
            
            // Выбор кусочка шоколада
            function selectChocolatePiece(piece) {
                if (state.currentObject !== 'chocolate' || !state.denominator) return;
                
                piece.classList.toggle('selected');
                const selected = document.querySelectorAll('.chocolate-piece.selected').length;
                
                // Обновление числителя
                state.numerator = selected;
                updateFractionDisplay();
                
                // Проверка решения
                checkSolution();
            }
            
            // Создание срезов пиццы (только для 4, 6, 8, 10 частей)
            function createPizzaSlices() {
                // Очистка предыдущих срезов
                const pizzaSlices = document.querySelectorAll('.slice, .slice-line');
                pizzaSlices.forEach(slice => slice.remove());
                
                // Проверяем, что знаменатель допустим для пиццы
                const validDenominators = [4, 6, 8, 10];
                if (!validDenominators.includes(state.denominator)) return;
                
                // Создание линий разреза
                for (let i = 0; i < state.denominator; i++) {
                    const sliceLine = document.createElement('div');
                    sliceLine.className = 'slice-line';
                    sliceLine.style.transform = `rotate(${i * (360 / state.denominator)}deg)`;
                    elements.pizza.appendChild(sliceLine);
                }
                
                // Создание секторов для выбора
                for (let i = 0; i < state.denominator; i++) {
                    const slice = document.createElement('div');
                    slice.className = 'slice';
                    slice.dataset.index = i;
                    
                    // Рассчитываем углы для сектора
                    const startAngle = i * (360 / state.denominator);
                    const endAngle = (i + 1) * (360 / state.denominator);
                    
                    // Преобразование углов в радианы
                    const startRad = (startAngle - 90) * Math.PI / 180;
                    const endRad = (endAngle - 90) * Math.PI / 180;
                    
                    // Координаты точек на окружности
                    const center = 50;
                    const radius = 50;
                    
                    // Рассчитываем координаты точек
                    const x1 = center + radius * Math.cos(startRad);
                    const y1 = center + radius * Math.sin(startRad);
                    const x2 = center + radius * Math.cos(endRad);
                    const y2 = center + radius * Math.sin(endRad);
                    
                    // Устанавливаем clip-path
                    slice.style.clipPath = `polygon(50% 50%, ${x1}% ${y1}%, ${x2}% ${y2}%)`;
                    slice.addEventListener('click', () => selectPizzaSlice(slice));
                    elements.pizza.appendChild(slice);
                }
            }
            
            // Выбор среза пиццы
            function selectPizzaSlice(slice) {
                if (state.currentObject !== 'pizza' || !state.denominator) return;
                
                slice.classList.toggle('selected');
                const selected = document.querySelectorAll('.slice.selected').length;
                
                // Обновление числителя
                state.numerator = selected;
                updateFractionDisplay();
                
                // Проверка решения
                checkSolution();
            }
            
            // Подготовка кнопок числителя
            function prepareNumeratorButtons() {
                const buttons = elements.numeratorButtons.querySelectorAll('button');
                
                buttons.forEach(button => {
                    const numerator = parseInt(button.textContent);
                    
                    if (numerator <= state.denominator) {
                        button.classList.remove('hidden');
                        button.disabled = false;
                    } else {
                        button.classList.add('hidden');
                    }
                });
            }
            
            // Установка числителя
            function setNumerator(numerator) {
                state.numerator = numerator;
                updateFractionDisplay();
                
                // Выделение выбранных частей
                highlightSelectedParts();
                
                // Проверка решения
                checkSolution();
            }
            
            // Обновление отображения дроби
            function updateFractionDisplay() {
                if (state.denominator && state.numerator !== null) {
                    elements.fractionDisplay.textContent = `${state.numerator}/${state.denominator}`;
                } else if (state.denominator) {
                    elements.fractionDisplay.textContent = `?/${state.denominator}`;
                } else {
                    elements.fractionDisplay.textContent = "?";
                }
            }
            
            // Выделение выбранных частей на всех объектах
            function highlightSelectedParts() {
                if (state.numerator === null || state.numerator === 0) return;
                
                // Для пиццы
                if (state.currentObject === 'pizza') {
                    const slices = document.querySelectorAll('.slice');
                    slices.forEach((slice, index) => {
                        if (index < state.numerator) {
                            slice.classList.add('selected');
                        } else {
                            slice.classList.remove('selected');
                        }
                    });
                }
                
                // Для шоколадки
                else if (state.currentObject === 'chocolate') {
                    const pieces = document.querySelectorAll('.chocolate-piece');
                    pieces.forEach((piece, index) => {
                        if (index < state.numerator) {
                            piece.classList.add('selected');
                        } else {
                            piece.classList.remove('selected');
                        }
                    });
                }
                
                // Для кексов
                else if (state.currentObject === 'cupcakes') {
                    const cupcakes = document.querySelectorAll('.cupcake');
                    cupcakes.forEach((cupcake, index) => {
                        if (index < state.numerator) {
                            cupcake.classList.add('selected');
                        } else {
                            cupcake.classList.remove('selected');
                        }
                    });
                }
            }
            
            // Проверка решения
            function checkSolution() {
                if (state.numerator === null || !state.denominator) return;
                
                const correctNumerator = state.currentFraction[0];
                const correctDenominator = state.currentFraction[1];
                
                if (state.numerator === correctNumerator && state.denominator === correctDenominator) {
                    // Правильный ответ
                    elements.feedback.className = "feedback positive";
                    elements.feedback.innerHTML = `
                        <p>Отлично! Это ${state.numerator}/${state.denominator} ${getObjectName()}! 🎉</p>
                        <p>Ты заработал +5 XP! ⭐</p>
                    `;
                    
                    // Начисление XP
                    state.xp += 5;
                    state.completedTasks++;
                    elements.xpDisplay.textContent = state.xp;
                    
                    // Обновление уровня и ранга
                    updateLevel();
                    
                    // Переход к следующему заданию через 2 секунды
                    setTimeout(() => {
                        state.currentTaskIndex = (state.currentTaskIndex + 1) % state.tasks.length;
                        
                        // Если прошли все задания, генерируем новые
                        if (state.currentTaskIndex === 0) {
                            state.tasks = generateUniqueTasks();
                        }
                        
                        loadTask();
                    }, 2000);
                } else {
                    // Неправильный ответ
                    elements.feedback.className = "feedback negative";
                    
                    if (state.numerator > correctNumerator) {
                        elements.feedback.innerHTML = `
                            <p>Слишком много! 🤔</p>
                            <p>Попробуй выбрать меньше частей.</p>
                        `;
                    } else if (state.numerator < correctNumerator) {
                        elements.feedback.innerHTML = `
                            <p>Мало частей! 🤔</p>
                            <p>Попробуй выбрать больше частей.</p>
                        `;
                    } else {
                        elements.feedback.innerHTML = `
                            <p>Почти получилось! 🤔</p>
                            <p>Проверь, правильно ли ты разделил предмет.</p>
                        `;
                    }
                }
            }
            
            // Получение названия объекта
            function getObjectName() {
                switch (state.currentObject) {
                    case 'pizza': return 'пиццу';
                    case 'chocolate': return 'шоколадку';
                    case 'cupcakes': return 'кексы';
                    default: return '';
                }
            }
            
            // Активация кнопок знаменателя
            function enableDenominatorButtons() {
                elements.denominatorButtons.querySelectorAll('button').forEach(btn => {
                    btn.disabled = false;
                });
            }
            
            // Блокировка кнопок знаменателя
            function disableDenominatorButtons() {
                elements.denominatorButtons.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                });
            }
            
            // Активация кнопок числителя
            function enableNumeratorButtons() {
                elements.numeratorButtons.querySelectorAll('button').forEach(btn => {
                    if (!btn.classList.contains('hidden')) {
                        btn.disabled = false;
                    }
                });
            }
            
            // Блокировка кнопок числителя
            function disableNumeratorButtons() {
                elements.numeratorButtons.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                });
            }
            
            // Обновление уровня
            function updateLevel() {
                let currentLevel = levels[0];
                
                // Находим текущий уровень
                for (let i = levels.length - 1; i >= 0; i--) {
                    if (state.xp >= levels[i].xp) {
                        currentLevel = levels[i];
                        break;
                    }
                }
                
                // Обновляем отображение
                elements.rankDisplay.textContent = currentLevel.rank;
                
                // Обновляем бейджи
                const badges = document.querySelectorAll('.badge');
                badges.forEach((badge, index) => {
                    badge.classList.remove('earned');
                    if (index < levels.indexOf(currentLevel)) {
                        badge.classList.add('earned');
                    }
                });
            }
            
            // Запуск приложения
            init();
        });
    </script>
</body>
</html>